!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.ndx=t.ndx||{})}(this,function(t){"use strict";function e(t){return t.trim().split(d)}function i(t){return t.toLowerCase()}function n(t){return t.replace(h,"").replace(u,"")}function r(t,e,i){for(;i<e.length;i++){var n=new a(e.charCodeAt(i));null===t.firstChild?t.firstChild=n:(n.next=t.firstChild,t.firstChild=n),t=n}return t}function o(t,e){for(var i=t.firstChild;null!==i;){if(i.charCode===e)return i;i=i.next}}function s(t,e,i){null!==t.firstPosting&&null!==t.firstPosting&&e.push(i);for(var n=t.firstChild;null!==n;)s(n,e,i+String.fromCharCode(n.charCode)),n=n.next}function f(t){for(var e=null,i=t.firstPosting;null!==i;)i.details.removed?null===e?t.firstPosting=i.next:e.next=i.next:e=i,i=i.next;for(var n=t.firstChild;null!==n;)f(n),n=n.next}function l(t){return n(i(t))}var d=/[\s]+/,h=/^\W+/,u=/\W+$/,a=function(){function t(t){this.charCode=t,this.next=null,this.firstChild=null,this.firstPosting=null}return t}(),c=function(){function t(){this.root=new a(0)}return t.prototype.get=function(t){for(var e=this.root,i=0;i<t.length;i++)if(void 0===(e=o(e,t.charCodeAt(i))))return null;return e},t.prototype.add=function(t,e,i){for(var n=this.root,s=0;s<t.length;s++){if(null===n.firstChild){n=r(n,t,s);break}var f=o(n,t.charCodeAt(s));if(void 0===f){n=r(n,t,s);break}n=f}var l={next:null,details:e,termFrequency:i};null===n.firstPosting?n.firstPosting=l:(l.next=n.firstPosting,n.firstPosting=l)},t.prototype.expandTerm=function(t){var e=this.get(t),i=[];return null!==e&&s(e,i,t),i},t.prototype.vacuum=function(){f(this.root)},t}(),v=function(){function t(t){if(this._documents=new Map,this._index=new c,this._fields=[],this._tokenizer=e,this._filter=l,this._bm25k1=1.2,this._bm25b=.75,void 0!==t){void 0!==t.tokenizer&&(this._tokenizer=t.tokenizer),void 0!==t.filter&&this._filter;var i=t.bm25;void 0!==i&&(void 0!==i.k1&&(this._bm25k1=i.k1),void 0!==i.b&&(this._bm25b=i.b))}}return Object.defineProperty(t.prototype,"size",{get:function(){return this._documents.size},enumerable:!0,configurable:!0}),t.prototype.addField=function(t,e){var i=t,n=1;void 0!==e&&(void 0!==e.getter&&(i=e.getter),void 0!==e.boost&&(n=e.boost));var r={name:t,getter:i,boost:n,sumLength:0,avgLength:0};this._fields.push(r)},t.prototype.add=function(t,e){for(var i=this,n=new Array(this._fields.length),r=new Map,o=0;o<this._fields.length;o++){var s=this._fields[o],f=s.getter,l="string"==typeof f?e[f]:f(e);if(void 0===l)n[o]=0;else{for(var d=this._tokenizer(l),h=0,u=0;u<d.length;u++){var a=this._filter(d[u]);if(""!==a){h++;var c=r.get(a);void 0===c&&(c=new Array(this._fields.length).fill(0),r.set(a,c)),c[o]+=1}}s.sumLength+=h,s.avgLength=s.sumLength/(this._documents.size+1),n[o]=h}}var v={docId:t,removed:!1,fieldLengths:n};this._documents.set(t,v),r.forEach(function(t,e){i._index.add(e,v,t)})},t.prototype.remove=function(t){var e=this._documents.get(t);if(void 0!==e){e.removed=!0,this._documents.delete(t);for(var i=0;i<this._fields.length;i++){var n=e.fieldLengths[i];if(n>0){var r=this._fields[i];r.sumLength-=n,r.avgLength=r.sumLength/this._documents.size}}}},t.prototype.search=function(t){for(var e=this._tokenizer(t),i=new Map,n=0;n<e.length;n++){var r=this._filter(e[n]);if(""!==r)for(var o=this._index.expandTerm(r),s=new Set,f=0;f<o.length;f++){var l=o[f],d=l===r?1:Math.log(1+1/(1+l.length-r.length)),h=this._index.get(l);if(null!==h&&null!==h.firstPosting){for(var u=0,a=h.firstPosting,c=null;null!==a;)a.details.removed?null===c?h.firstPosting=a.next:c.next=a.next:(c=a,u++),a=a.next;if(u>0){var v=Math.log(1+(this.size-u+.5)/(u+.5));for(a=h.firstPosting;null!==a;){if(!a.details.removed){for(var g=0,p=0;p<a.details.fieldLengths.length;p++){var m=a.termFrequency[p];if(m>0){var _=a.details.fieldLengths[p],x=this._fields[p],b=x.avgLength,y=this._bm25k1,C=this._bm25b;m=(y+1)*m/(y*(1-C+C*(_/b))+m),g+=m*v*x.boost*d}}if(g>0){var L=a.details.docId,k=i.get(L);void 0!==k&&s.has(L)?i.set(L,Math.max(k,g)):i.set(L,void 0===k?g:k+g),s.add(L)}}a=a.next}}}}}var P=[];return i.forEach(function(t,e){P.push({docId:e,score:t})}),P.sort(function(t,e){return e.score-t.score}),P},t.prototype.expandTerm=function(t){return this._index.expandTerm(t)},t.prototype.queryToTerms=function(t){for(var e=[],i=this._tokenizer(t),n=0;n<i.length;n++){var r=this._filter(i[n]);""!==r&&(e=e.concat(this._index.expandTerm(r)))}return e},t.prototype.vacuum=function(){this._index.vacuum()},t}();t.whitespaceTokenizer=e,t.lowerCaseFilter=i,t.trimNonWordCharactersFilter=n,t.DocumentIndex=v,t.DEFAULT_FILTER=l,Object.defineProperty(t,"__esModule",{value:!0})});